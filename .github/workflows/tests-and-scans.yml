name: Tests + Scans
on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - 'main'
    tags:
      - 'v*'
jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Run Tests
        run: npm test
 
  e2e_tests:
    name: E2E Tests (iOS + Maestro)
    runs-on: macos-14
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Xcode 15.3
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.3'
      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "PATH=$HOME/.maestro/bin:$PATH" >> $GITHUB_ENV
          echo "MAESTRO_DRIVER_STARTUP_TIMEOUT=180000" >> $GITHUB_ENV
      - name: Boot and Activate iOS Simulator
        shell: bash
        run: |
          # Find or create an iPhone simulator
          SIMULATOR_UDID=$(xcrun simctl list devices available iPhone | grep -m 1 "iPhone" | grep -o '([A-F0-9-]*)\s*$' | tr -d '() ' || echo "")
          
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "Creating new iPhone 15 simulator"
            SIMULATOR_UDID=$(xcrun simctl create "iPhone-15-Test" "iPhone 15" "iOS17.2")
          fi
          
          echo "Using simulator: $SIMULATOR_UDID"
          echo "SIMULATOR_UDID=$SIMULATOR_UDID" >> $GITHUB_ENV
          
          # Boot simulator
          xcrun simctl shutdown "$SIMULATOR_UDID" || true
          xcrun simctl boot "$SIMULATOR_UDID"
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b
          
          # Wait for UI to be fully ready
          echo "Waiting for simulator UI services to be ready..."
          sleep 30
          
          # Verify simulator is responsive
          xcrun simctl list devices | grep Booted || true
          xcrun simctl list devices "$SIMULATOR_UDID"
      - name: Extract .app from Archive
        run: |
          tar -xzf example/build-example.tar.gz
      - name: Install .app on Simulator
        run: |
          APP_PATH=example.app
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"
      - name: Launch Application
        run: |
          APP_BUNDLE_ID=vgscollectreactnative.example
          xcrun simctl launch "$SIMULATOR_UDID" "$APP_BUNDLE_ID"
          sleep 15
          
          # Verify app is running
          xcrun simctl spawn "$SIMULATOR_UDID" launchctl list | grep "$APP_BUNDLE_ID" || true
          
          echo "Waiting for app to fully initialize..."
          sleep 10
      - name: Run Maestro Tests
        run: |
          echo "Starting Maestro tests with UDID: $SIMULATOR_UDID"
          maestro test example/.maestro/collect_card_form_invalid.yaml
      - name: Upload Maestro Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: ~/.maestro/tests/
          if-no-files-found: warn
